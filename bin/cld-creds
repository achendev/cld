#!/bin/bash
source /var/cld/bin/include/cldfuncs
[ "$SUDO_USER" = "" ] && SUDO_USER=admin
for VM in $(CLOUDS_USER_ALLOWED | grep -i "$1" | grep -i "$2" | grep -i "$3")
do
  CLD_LOGS
  if [ "$VM" = "" ] ; then
   echo "you choosed incorrect VM, please try again and type numbers only"
  else
    GROUP=$(grep -l $VM /var/cld/access/groups/*/clouds | cut -d '/' -f 6 | tail -1)
    if [ "$GROUP" = "" ] ; then echo "choosen CLOUD have incorrect GROUP" ; exit 1 ; fi
    if grep -qs "1" /var/cld/access/groups/${GROUP}/funcs
    then
    source <(for GROUPFUNC in funcvars 
        do
          echo "${GROUP}_${GROUPFUNC}(){"
          cat /var/cld/access/groups/${GROUP}/${GROUPFUNC}
          echo '}'
        done)
      CLD_VARS=${GROUP}_funcvars
    else
      CLD_VARS=EXTERNAL_VARS
    fi
    echo
    $CLD_VARS
    for CRED in $(declare -f $CLD_VARS | grep "=" | cut -d = -f 1)
    do
      test $CRED && echo $(echo $CRED | sed -e 's#VMN#Host:#' -e 's#SRV#ip:#' -e 's#USR#user:#' -e 's#PRT#port:#' -e 's#PWD#password:#') \`${!CRED}\`
    done
  fi
done