#!/bin/bash
HELP_DESC=$(cat << 'EOL'
Classicdeploy update tool
EOL
)
HELP_EXAMPLES=$(cat << 'EOL'
cld-update
EOL
)
HELP_ONLY="CLI"
source /var/cld/bin/include/cldfuncs
echo Stop services
systemctl stop cld
systemctl stop cron &>/dev/null
systemctl stop crond &>/dev/null
echo Check and wait if there current access list deploy
while $(ps axfu | grep -v grep | grep -q cld-accesslistdeploy); do sleep 1s; done
chattr -i /var/cld
cd /var/cld && git pull --force
[ -e "/var/cld/tmp" ] || mkdir -p /var/cld/tmp &>/dev/null
echo Update users rights according access matrix /var/cld/creds/passwd
/var/cld/bin/cld-initpasswd &>/dev/null
echo Start services
systemctl start cld
systemctl start cron &>/dev/null
systemctl start crond &>/dev/null
echo Update private and public documentation
{ /var/cld/modules/doc/bin/cld-docpublicgen & disown ; } &>/dev/null
python3 /var/cld/modules/doc/doc.py &>/dev/null