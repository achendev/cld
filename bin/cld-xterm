#!/bin/bash
CLOUDID=$1
SESSID=$2
CLDUSER=$3
if [ "$CLOUDID" = "" ] ; then
 echo "CLOUDID is not defined" ; exit 1
fi
#Clean SESSID file
(
for CLOUDID in $(awk '{print $4}' /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid | egrep -o "[a-z0-9]{8}" | sort -n -u)
do
for COOKIE in $(awk -v CLOUDID=$CLOUDID 'CLOUDID {print $13}' /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid | tr -d '")' | sort -u)
do
grep "${CLOUDID}" /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid | grep "${COOKIE}" | tail -1
done
done
) > /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid_tmp ; mv -f /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid_tmp /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid

#kill apps
kill -9 `ps axfu | egrep "port(\ |\=)" | grep -v "$(netstat -n | grep '172.17.0.1' | grep ESTABLISHED | awk '{print $4}' | cut -d : -f 2)" | awk '{print $2}'`

#Define XTERMPORT
for XTERMPORT in $(seq 45001 50000)
do
echo quit | telnet 172.17.0.1 ${XTERMPORT} 2>&1 | grep -q 'refused' && PORTFREE=1 || PORTFREE=0
grep -q "${XTERMPORT}" /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid && PORTFREE=0
ps axfu | grep -q node | grep -q ${XTERMPORT} && PORTFREE=1
echo $PORTFREE | grep -q '1' && export XTERMPORT=${XTERMPORT} && break
done

cat >> /var/cld/docker/xtermnginx/etc/nginx/conf.d/sessid << EOL
if (\$request_uri ~ /xterm/${CLOUDID}.*) { set \$X${CLOUDID}  "A"; } if (\$cookie_session = "$SESSID") { set \$X${CLOUDID}  "\${X${CLOUDID}}B"; } if (\$X${CLOUDID} = "AB") { set \$XTERMPORT ${XTERMPORT}; set \$XTERMIP 172.17.0.1; }
if (\$request_uri ~ /files/${CLOUDID}.*) { set \$X${CLOUDID}  "A"; } if (\$cookie_session = "$SESSID") { set \$X${CLOUDID}  "\${X${CLOUDID}}B"; } if (\$X${CLOUDID} = "AB") {set \$XTERMPORT ${XTERMPORT}; set \$XTERMIP 172.17.0.250; }
EOL
docker exec -it xtermnginx service nginx reload &>/dev/null

mkdir -p /var/log/cld/ &>/dev/null
CLOUD=$(/var/cld/bin/cldbyid ${CLOUDID})
echo "/var/cld/bin/cldbyid ${CLOUDID}" >> /var/log/cld/cmd.log
echo ${CLOUD} >> /var/log/cld/cmd.log
#kill -9 `ps axfu | grep "/var/cld/xtermjs/sockets/${CLOUDID}.serial0\|/var/cld/xtermjs/app.js" | grep ${CLOUDID} | grep -v "grep" | awk '{print $2}'` 2>/dev/null 1>/dev/null
screen -dm timeout 30m sudo -u ${CLDUSER} sudo /usr/bin/node /var/cld/wetty/index.js ${CLOUD} --command "/var/cld/bin/cldx" --base "/xterm/${CLOUDID}/" --title "CloudPlatform terminal" --host "172.17.0.1" --port ${XTERMPORT}
echo "$(date) - /usr/bin/node /var/cld/wetty/index.js ${CLOUD} --command \"/var/cld/bin/cldx\" --base \"/xterm/${CLOUDID}/\" --title \"CloudPlatform terminal\" --host "172.17.0.1" --port ${XTERMPORT}" >> /var/log/cld/cmd.log

#(sudo -u ${CLDUSER} sudo /var/cld/bin/cldxmount ${CLOUD} ; screen -s bash -dm sudo timeout 30m python3 /var/cld/flaskfilemanager/cldapp/app.py --targetpath=/home/${CLDUSER}/mnt/${CLOUD} --listenport=${XTERMPORT}) &>/dev/null & disown
(sudo -u ${CLDUSER} sudo /var/cld/bin/cldxmount ${CLOUD} ; screen -s bash -dm sudo timeout 30m python3 /var/cld/RichFilemanager-Python3Flask/FlaskApp.py --targetpath=/home/${CLDUSER}/mnt/${CLOUD} --listenport=${XTERMPORT}) &>/dev/null & disown
screen -dm docker exec -it xtermnginx service nginx reload
screen -wipe &>/dev/null & disown
while :; do wget --server-response --spider http://172.17.0.1:${XTERMPORT}/xterm/${CLOUDID} 2>&1 | grep -q '200 OK' && break ; sleep 0.5s ; done
#screen -dm timeout 30m python3 /var/cld/flaskfilemanager/cldapp/app.py --targetpath=${CLOUDPATH} --listenport=${XTERMPORT}
echo ${XTERMPORT}
