#!/bin/bash
ARG1=$(echo "${@:1}" | tr ' ' '\n' | grep -v '\--' | head -1)
ARG2=$(echo "${@:1}" | tr ' ' '\n' | grep -v '\--' | head -2 | tail -1)

ORIGIN_IP=$ARG1
TARGET_IP=$ARG2

for OPTS in ${@:1}
do
echo $OPTS | grep -q  '^\--proxy\|^\-proxy' && CFPROXY="-proxy"
done

CURR_DATE=$(TZ=Europe/Moscow date +%F)
/var/cld/modules/dns/cf_dns_backup

A_RECORD_LIST=$(grep "$ORIGIN_IP" -R /var/cld/modules/dns/data/cf/${CURR_DATE}/ | cut -d : -f 2- | grep -P "\tA\t$ORIGIN_IP" | cut -d A -f 1 | rev | cut -d . -f 2- | rev)

for A_RECORD in $(A_RECORD_LIST)
do
echo cld-setdns A ${A_RECORD} ${ORIGIN_IP}_${TARGET_IP} ${CFPROXY}
done