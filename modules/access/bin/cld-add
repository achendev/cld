#!/bin/bash
source /var/cld/bin/include/cldfuncs
CLOUD=$1
GROUP=$2
[ "$GROUP" ] || GROUP=default
CLOUDSFILE=/var/cld/access/groups/$GROUP/clouds

if [[ "$CLOUD" =~ ^[A-Za-z0-9.-]+_((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?) ]]
then
VMN=$(cut -d "_" -f 1 <<< $CLOUD)
SRV=$(cut -d "_" -f 2 <<< $CLOUD)
PRT=$(cut -d "_" -f 3 <<< $CLOUD)
USR=$(cut -d "_" -f 4 <<< $CLOUD)
PWD=$(cut -d _ -f 5- <<< $CLOUD)
[ "${PRT}" ] || PRT=22
[ "${USR}" ] || USR=root
[ "${PWD}" ] && PWD=_${PWD}
echo "${VMN}_${SRV}_${PRT}_${USR}${PWD}" >> ${CLOUDSFILE}
echo instance ${VMN}_${SRV}_${PRT}_${USR} addes to group ${GROUP}
else
if ! [ "${!VALUE}" ]
then
  while ! [[ "$VALUE" =~  ^[A-Za-z0-9/:.@%_,\ -]+$ ]]
do
echo -e "Please enter the VALUE for ${CONSTANT} constant using [A-Za-z0-9/:._ -] - symbols\nEXAMPLE: ${EXAMPLE}"
echo -n "#: " ; read VALUE
echo
done
fi

init-string 'NAME|server1.example.com|[A-Za-z0-9.-]+' 'IP|1.2.3.4|[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' 'PORT|22|[0-9]{2,5}' 'user|root|[A-Za-z0-9@.-]+' --file=${CLOUDSFILE}
fi