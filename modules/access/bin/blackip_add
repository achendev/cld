#!/bin/bash
mkdir -p /var/cld/modules/access/data/ &>/dev/null
echo ${1} | egrep -q "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" || echo "ip address is incorrect please fix it and try again"
echo ${1} | egrep -q "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" || exit 1
grep -q "${1}" /var/cld/modules/access/data/enabledips && echo "ip \`${1}\` already enabled in access list" || (echo "${1}_${2}_`TZ=Europe/Moscow date +%F-%H-%M`" >> /var/cld/modules/access/data/enabledips && echo "ip \`${1}\` successfully added to access list with comment *${2}*")
cat /var/cld/modules/access/data/myips /var/cld/modules/access/data/enabledips | cut -d _ -f 1 | uniq > /var/cld/api/accesslist 2>/dev/null
(cat /var/cld/modules/access/data/myips /var/cld/modules/access/data/enabledips | cut -d _ -f 1 | uniq | awk '{print "acl localnet src "$1"/32"}' > /etc/squid/allow_hosts; systemctl reload squid) &>/dev/null
#bash -lc "/var/cld/modules/access/bin/access_list_to_mikrotik" &
