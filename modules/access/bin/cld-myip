#!/bin/bash
source /var/cld/bin/include/cldfuncs
source /var/cld/creds/creds_security_system
init-load-constants TELEGRAM_BOT_TOKEN\|1234567890:AAEzBFqFii-uirfyG3PnygA0DAvJvRH7UzB CLD_DOMAIN\|cldapi.yourdomain.com
echo ${3} | egrep -q "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" || (export TOKEN="$(uuidgen | tr -d '-')" ; echo "${TOKEN}_${1}_${2}_`TZ=Europe/Moscow date +%F-%H-%M`" >> /var/cld/modules/access/data/myip_tokens ; echo "To add your ip address to the white list, please visit: 
https://${CLD_DOMAIN}/api/myipinit?token=${TOKEN}")
echo ${3} | egrep -q "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" || exit 0
grep -q ${1} /var/cld/bot/myips && (sed -i "s#.*${1}.*#${3}_${1}_${2}_`TZ=Europe/Moscow date +%F-%H-%M`#g" /var/cld/modules/access/data/myips ; echo "private ip ${F}${3}${F} successfully updated for user ${B}${2}${B}") || (echo "${3}_${1}_${2}_`TZ=Europe/Moscow date +%F-%H-%M`" >> /var/cld/bot/myips ; echo "private ip ${F}${3}${F} successfully added to access list for user ${B}${2}${B}")
cat /var/cld/modules/access/data/myips /var/cld/modules/access/data/enabledips | cut -d _ -f 1 | sort -u > /var/cld/api/accesslist 2>/dev/null
(cat /var/cld/api/accesslist | uniq | awk '{print "acl localnet src "$1"/32"}' > /etc/squid/allow_hosts; systemctl reload squid) &>/dev/null & disown
(cat /var/cld/api/accesslist | sort -u | awk '{print "allow "$1"/32;"}' > /etc/nginx/accesslist && service nginx reload) &>/dev/null & disown

bash -lc "/var/cld/modules/access/bin/access_list_to_ssh" &>/dev/null &

#iron throne deploy
#bash -lc "/var/cld/bot/bin/access_list_to_mikrotik" &
