#!/bin/bash
ALLOWED_IPS=$(cat << EOIPS
$(cat /etc/hosts.allow | awk '{print $2}'  | egrep -o "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}")
EOIPS
)

#Should be MORE than 1 ports
ALLOWED_PORTS=$(cat << 'EOPORTS'
3306
8006
10050
15672
EOPORTS
)

source <(
iptables-save | grep -v "$ALLOWED_PORTS" | iptables-restore
echo "iptables -A INPUT -s 172.16.0.0/24 -p tcp -m tcp -m multiport --dports $(echo $ALLOWED_PORTS | tr ' ' ',') -j ACCEPT"
for IP in $ALLOWED_IPS
do
cat << EOL
iptables -A INPUT -s ${IP}/32 -p tcp -m tcp -m multiport --dports $(echo $ALLOWED_PORTS | tr ' ' ',') -j ACCEPT
EOL
done
cat << EOL
iptables -A INPUT -p tcp -m tcp -m multiport --dports $(echo $ALLOWED_PORTS | tr ' ' ',') -j DROP
EOL
)

