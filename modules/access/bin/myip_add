#!/bin/bash
source /var/cld/creds/creds_security_system
init-load-constants ACCESS_BOT_TOKEN ACCESS_API_DOMAIN
echo ${3} | egrep -q "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" || (export TOKEN="$(uuidgen | tr -d '-')" ; echo "${TOKEN}_${1}_${2}_`TZ=Europe/Moscow date +%F-%H-%M`" >> /var/cld/modules/access/data/myip_tokens ; echo "To add your ip address to the white list, please visit: 
https://${ACCESS_API_DOMAIN}/myip?token=${TOKEN}")
echo ${3} | egrep -q "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" || exit 0
grep -q ${1} /var/cld/bot/myips && (sed -i "s#.*${1}.*#${3}_${1}_${2}_`TZ=Europe/Moscow date +%F-%H-%M`#g" /var/cld/modules/access/data/myips ; echo "private ip \`${3}\` successfully updated for user *${2}*") || (echo "${3}_${1}_${2}_`TZ=Europe/Moscow date +%F-%H-%M`" >> /var/cld/bot/myips ; echo "private ip \`${3}\` successfully added to access list for user *${2}*")
cat /var/cld/modules/access/data/myips /var/cld/modules/access/data/enabledips | cut -d _ -f 1 | uniq > /var/cld/api/accesslist 2>/dev/null
(cat /var/cld/modules/access/data/myips /var/cld/modules/access/data/enabledips | cut -d _ -f 1 | uniq | awk '{print "acl localnet src "$1"/32"}' > /etc/squid/allow_hosts; systemctl reload squid) &>/dev/null
bash -lc "/var/cld/modules/access/bin/access_list_to_ssh" &>/dev/null &

#iron throne deploy
#bash -lc "/var/cld/bot/bin/access_list_to_mikrotik" &
