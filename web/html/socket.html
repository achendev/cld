<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Classic Deploy web shell</title>
  <style>
  html {font-family: arial;}
::-webkit-scrollbar {width: 5px;}
::-webkit-scrollbar-track {background: #000000;}
::-webkit-scrollbar-thumb {background: #747473;}
::-webkit-scrollbar-thumb:hover {background: #555;}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/xterm@3.6.0/dist/xterm.css" />
</head>
<body style="background: black;">

<span style="font-size: small;color: white;">classic deploy web shell</span>&nbsp;&nbsp;&nbsp;
<span style="font-size: small;color: white;">status: <span style="font-size: small;color: black;background-color: lightgray;" id="status">| connecting... |</span></span>

<div style="width: 100%; height: calc(100% - 50px);" id="terminal"></div>
<!-- xterm -->
<script src="https://unpkg.com/xterm@3.6.0/dist/xterm.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/fit/fit.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/webLinks/webLinks.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/fullscreen/fullscreen.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/search/search.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/attach/attach.js"></script>
<script src="https://unpkg.com/xterm@3.6.0/dist/addons/winptyCompat/winptyCompat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.5/socket.io.js"></script>

<script>
  Terminal.applyAddon(fullscreen)
  Terminal.applyAddon(fit)
  Terminal.applyAddon(webLinks)
  Terminal.applyAddon(search)
  const term = new Terminal({
        cursorBlink: false,
        macOptionIsMeta: true,
        scrollback: 20000,
    });
  term.open(document.getElementById('terminal'));
  term.fit()
  term.resize(15, 50)
  console.log(`size: ${term.cols} columns, ${term.rows} rows`)
  // term.toggleFullScreen(true)
  term.fit()
  term.on('key', (key, ev) => {
    console.log("pressed key", key)
    console.log("event", ev)
    socket.emit("pty-input", {"input{{socketid}}": key, query: 'socketid={{socketid}}'})
  });

  term.on('paste', (data, ev) => {
    console.log("pasted data", data)
    console.log("event", ev)
    socket.emit("pty-input", {"input{{socketid}}": data, query: 'socketid={{socketid}}'})
  });

  const socket = io.connect('/pty', {query: {'socketid': '{{socketid}}', 'cldutility': '{{cldutility}}', 'args': '{{cmd_args}}'}});
  const status = document.getElementById("status")

  socket.on("pty-output", function(data){
    console.log("new output", data)
    term.write(data.output{{socketid}})
  })

  socket.on("connect", () => {
    fitToscreen()
    socket.emit('room', '{{"room"+socketid}}');
    status.innerHTML = '<span style="background-color: lightgreen;color: black;">| connected |</span>'
    }
  )

  socket.on("disconnect{{socketid}}", () => {
    status.innerHTML = '<span style="background-color: #ff8383;">| disconnected |</span>'
  })

  function fitToscreen(){
    term.fit()
    socket.emit("resize", {"cols": term.cols, "rows": term.rows, query: 'socketid={{socketid}}'})
  }

  function debounce(func, wait_ms) {
    let timeout
    return function(...args) {
      const context = this
      clearTimeout(timeout)
      timeout = setTimeout(() => func.apply(context, args), wait_ms)
    }
  }

  const wait_ms = 50;
  window.onresize = debounce(fitToscreen, wait_ms)

function copySelectionText(){
    var copysuccess // var to check whether execCommand successfully executed
    try{
        copysuccess = document.execCommand("copy") // run command to copy selected text to clipboard
    } catch(e){
        copysuccess = false
    }
    return copysuccess
}

document.body.addEventListener('mouseup', function(){
    var copysuccess = copySelectionText() // copy user selected text to clipboard
}, false)

document.body.addEventListener('mouseup', function(){
    var selected = getSelectionText() // call <a href="#getselectiontext">getSelectionText()</a> to see what was selected
    if (selected.length > 0){ // if selected text length is greater than 0
        var copysuccess = copySelectionText() // copy user selected text to clipboard
    }
}, false)
</script>

</body>
</html>